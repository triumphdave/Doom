[force_move]
enable_force_move: True
#############################################################################################################
### CONFIGURATION GENERATED BY THE RATOS CONFIGURATOR
#############################################################################################################
[include RatOS.cfg]

#############################################################################################################

  ######################################################################################################

  #[neopixel light_strip]
#pin: PA8                      # Replace with the pin connected to the data line of the LED strip
#chain_count: 30               # Number of LEDs in your strip
#color_order: RGBW             # SK6812 uses RGBW; adjust if needed
#initial_RED: 0                # Initial brightness for Red
#initial_GREEN: 0              # Initial brightness for Green
#initial_BLUE: 0               # Initial brightness for Blue
#initial_WHITE: 0              # Initial brightness for White

########################################################################################################

#[gcode_macro SET_LED]
#description: Set SK6812 RGBWW LED colors
#default_parameter_r: 0
#default_parameter_g: 0
#default_parameter_b: 0
#default_parameter_w: 0
#gcode:
    #SET_NEOPIXEL COLOR={r},{g},{b},{w}


  ####################################################################################################
#[gcode_macro LED_RAINBOW]
#description: Create a rainbow effect on the LED strip
#gcode:
#    NEOPIXEL_EFFECT RAINBOW SPEED=1  # Adjust speed as needed

#[gcode_macro LED_OFF]
#description: Turn off all LEDs
#gcode:
#    SET_NEOPIXEL COLOR=0,0,0,0


############################################################################################################

#############################################################################################################
### MACRO CONFIGURATION
### Configure the behavior of RatOS macros
### See: https://os.ratrig.com/docs/configuration/macros
#############################################################################################################
[gcode_macro RatOS]
variable_relative_extrusion: False
variable_preheat_extruder: False
variable_calibrate_bed_mesh: True
variable_nozzle_priming: "primeblob"
variable_start_print_park_in: "front"
variable_start_print_park_z_height: 25
variable_end_print_park_in: "back"
variable_pause_print_park_in: "front"
variable_macro_travel_speed: 400
variable_macro_travel_accel: 10000
variable_skew_profile: "my_skew_profile"
variable_end_print_motors_off: False


#############################################################################################################
### USER OVERRIDES & CUSTOM CONFIGURATION
### Anything custom you want to add, or RatOS configuration you want to override, do it here.
### This section is pre-populated with the most common settings you may want to change.
### See: https://os.ratrig.com/docs/configuration/includes-and-overrides
###
### It is recommended that you follow these steps to properly calibrate your printer:
### 0) Sanity check and PID Tuning: https://www.klipper3d.org/Config_checks.html
### 1) Z-offset calibration: run BEACON_RATOS_CALIBRATE to automatically calibrate your beacon for scan and contact.
###    IMPORTANT: Ensure the beacon is properly mounted and the nozzle and meltzone is clean by unloading
###    the filament (if it's loaded) and make sure there's no ooze or gunk on the nozzle when the hotend is at printing temperature.
### 2) Pressure Advance: https://www.klipper3d.org/Pressure_Advance.html
### 3) Skew Correction: https://www.klipper3d.org/Skew_Correction.html
### 4) Resonance Compensation: https://www.klipper3d.org/Resonance_Compensation.html
### RatOS has dedicated macro's to generate shaper graphs for deeper analysis (requires accelerometer).
### Use MEASURE_COREXY_BELT_TENSION to compare tension between belts, and use
### GENERATE_SHAPER_GRAPHS to generate the resonance graphs for analysing and manually entering input shaper
### configuration.
### You can run SHAPER_CALIBRATE to automatically calibrate your input shaper configuration, if you just want
### to get started.
### Additionally, you can use the Realtime Analysis Tool to analyze your printer's performance in real-time.
### Read more about klipper here: https://www.klipper3d.org/Overview.html
#############################################################################################################

#[skew_correction]

#####
# Beacon probe configuration
#####
[gcode_macro RatOS]
variable_beacon_bed_mesh_scv: 25                        # square corner velocity for bed meshing with proximity method
variable_beacon_contact_z_homing: True                 # Make all G28 calls use contact instead of proximity scan
variable_beacon_contact_start_print_true_zero: True     # Use contact to determine true Z=0 for the last homing move during START_PRINT
variable_beacon_contact_wipe_before_true_zero: True     # enables a nozzle wipe at Y10 before true zeroing
variable_beacon_contact_true_zero_temp: 150             # nozzle temperature for true zeroing
                                                        # WARNING: if you're using a smooth PEI sheet, be careful with the temperature

variable_beacon_contact_prime_probing: True             # probe for priming with contact method
variable_beacon_contact_expansion_compensation: True    # enables the nozzle thermal expansion compensation

variable_beacon_contact_bed_mesh: False                 # bed mesh with contact method
variable_beacon_contact_bed_mesh_samples: 2             # probe samples for contact bed mesh

variable_beacon_contact_z_tilt_adjust: False            # z-tilt adjust with contact method
variable_beacon_contact_z_tilt_adjust_samples: 2        # probe samples for contact z-tilt adjust

variable_beacon_scan_compensation_enable: False         # Enables the beacon scan compensation
variable_beacon_scan_compensation_profile: "Contact"    # The contact profile name for the scan compensation
variable_beacon_scan_compensation_probe_count: 15,15    # The contact probe count for the scan compensation

variable_beacon_contact_poke_bottom_limit: -1		    # The bottom limit for the contact poke test

########################################################

[printer]
kinematics: corexy
max_velocity: 500  
max_accel: 10000             
max_z_velocity: 30          
max_z_accel: 400
square_corner_velocity: 15.0

########################################################

########################################################

[resonance_tester]
accel_per_hz: 115 #added
hz_per_sec: 0.5 #added

#########################################################

#########################################################

[input_shaper]
 shaper_type_x = zv
 shaper_freq_x = 105.4
 shaper_type_y = zv
 shaper_freq_y = 73.8

########################################################

#########################################################

[exclude_object]             #Added#

[gcode_arcs]                 #Added#
resolution: 0.1

#########################################################

########################################################

[temperature_sensor chamber]
sensor_type: Generic 3950
sensor_pin: PC5               
min_temp: 0
max_temp: 80
gcode_id: C

##########################################################


#---------------------------------------------------- X -----------------------------------------------------
# The A motor in the CoreXY system located on the right side of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_x]
dir_pin: !x_dir_pin             # Remove ! in front of pin name to reverse the direction of stepper_x
rotation_distance: 40           # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 150
position_min: 0
position_max: 340
position_endstop: 340

#---------------------------------------------------- Y -----------------------------------------------------
# The B motor in the CoreXY system located on the left side of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_y]
dir_pin: !y_dir_pin              # Add ! in front of pin name to reverse the direction of stepper_y
rotation_distance: 40           # 40 for 20 tooth 2GT pulleys, 32 for 16 tooth 2GT pulleys
homing_speed: 150
position_min: 0
position_max: 351
position_endstop: 351

#---------------------------------------------------- Z -----------------------------------------------------
# The Z motor located on the front left of the bottom of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_z]
dir_pin: !z0_dir_pin            # Remove ! in front of pin name to reverse the direction of stepper_z
rotation_distance: 40 
homing_speed: 10
position_min: -5
position_max: 275
gear_ratio: 80:16

#---------------------------------------------------- Z1 ----------------------------------------------------
# The Z motor located on the rear left of the bottom of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_z1]
dir_pin: z1_dir_pin            # Remove ! in front of pin name to reverse the direction of stepper_z1
rotation_distance: 40 
gear_ratio: 80:16

#---------------------------------------------------- Z2 ----------------------------------------------------
# The Z motor located on the rear right of the bottom of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_z2]
dir_pin: !z2_dir_pin            # Remove ! in front of pin name to reverse the direction of stepper_z2
rotation_distance: 40 
gear_ratio: 80:16

#---------------------------------------------------- Z3 ----------------------------------------------------
# The Z motor located on the front right of the bottom of the printer
#------------------------------------------------------------------------------------------------------------
[stepper_z3]
dir_pin: z3_dir_pin            # Remove ! in front of pin name to reverse the direction of stepper_z3
rotation_distance: 40 
gear_ratio: 80:16

#------------------------------------------------- EXTRUDER -------------------------------------------------
# The extruder motor used for your toolhead
#------------------------------------------------------------------------------------------------------------
[extruder]
dir_pin: e_dir_pin             # Remove ! in front of pin name to reverse the direction of extruder
rotation_distance: 60     #61.2   # my worm #
#pressure_advance: 0.05         # Check https://www.klipper3d.org/Pressure_Advance.html for pressure advance tuning.
#control: pid
#pid_kp: 21.673
#pid_ki: 1.338
#pid_kd: 87.776

gear_ratio: 40:2    # my worm #

[heater_bed]
#control: pid
#pid_kp: 68.203
#pid_ki: 2.842
#pid_kd: 409.216

##############################################

[tmc2209 stepper_y1]
stealthchop_threshold: 0
interpolate: False
uart_pin: PG8
run_current: 1.6
driver_TBL: 2
driver_TOFF: 3
driver_HEND: 0
driver_HSTRT: 6
sense_resistor: 0.11

[stepper_y1]
step_pin: PA8
dir_pin: !PC7
enable_pin: !PC9
microsteps: 64
full_steps_per_rotation: 200
rotation_distance: 40

#################################################

[tmc2209 stepper_x1]
stealthchop_threshold: 0
interpolate: False
uart_pin: PD6
run_current: 1.6
driver_TBL: 2
driver_TOFF: 3
driver_HEND: 0
driver_HSTRT: 6
sense_resistor: 0.11

[stepper_x1]
step_pin: PA10
dir_pin: !PA9
enable_pin: !PA15
microsteps: 64
full_steps_per_rotation: 200
rotation_distance: 40

##################################################

[fan]    # Cpap #
pin: !PA6
max_power: 1
cycle_time: 0.0005
kick_start_time: 0.2
enable_pin: PF7
hardware_pwm: false
shutdown_speed: 0
off_below: 0.32

################################################

[include bedfans-dualcontrol.cfg]
#[include SYNC_MOTORS.cfg]

################################################

# Controller cooling fan
[controller_fan controller_fan]
# 2-pin fan connected to 2-pin header on Octopus Max EZ V1.0 - input voltage pwm
pin: PF9

##################################################

###  LED 

## Chamber Lighting 
[output_pin caselight]
pin: PA0
pwm:true
shutdown_value: 0
value:0.5
cycle_time: 0.01

#################################################

#[motors_sync]
#axes: x,y
#    Axes on which calibration will be performed.
#accel_chip: beacon
#    Accelerometer for vibrations collection: adxl345 / mpu9250 etc.
#encoder_chip_<axis>:
#    Axis, assigned encoder name, for measuring deviations.
#chip_filter: median
#    Filter type for data from the accelerometer: 'median' works well in
#    most cases, but some particularly noisy printers (fans, etc.) may
#    require a more powerful filter - 'kalman'. On lis2dw filters disabled.
#median_size: 3
#    Median filter window size.
#kalman_coeffs: 1.1, 1., 1e-1, 1e-2, .5, 1.
#    Simple coefficients describing the kalman filter.
#microsteps: 16
#    Maximum microstepping displacement of the stepper motor rotor.
#sync_method: default
#    Methods for synchronizing two axes on interconnected kinematics:
#    'alternately' - the axes calibrated alternately, step by step. (default)
#    'synchronous' - the axes calibrated depending on their magnitude,
#    trying to keep it at the same level.
#    Methods for synchronizing axis/axes on NOT-interconnected kinematics:
#    'sequential' - axes are calibrated sequentially. (default)
#steps_model: linear, 20000, 0
#    Mathematical model and its coefficients representing the dependence
#    of stepper motor microstep displacement on the measured magnitude.
#max_step_size: 5
#    The maximum number of microsteps that the motor can take move at time,
#    to achieve the planned magnitude.
#axes_steps_diff: 6
#    The difference in the positions of the motors in microsteps between
#    the two axes, to update the magnitude of the secondary axis. It is
#    used in the synchronous method, or in the process of axis alignment
#    in the alternately method. The typical value is max_step_size + 1.
#retry_tolerance: 1500
#    The forced threshold to which a pair of stepper motors on one belt
#    will have to lower the magnitude of the oscillations. It's recommended
#    to configure in order to filter possible inaccuracies. After several
#    iterations of starting synchronization, you will find the edge, to
#    which this parameter should be omitted.
#retries: 3
#    The maximum number of repetitions to achieve the forced threshold of
#    oscillations.
#head_fan:
#    Toolhead fan, which will be turned off during sync to eliminate noise.

###################################################

[gcode_macro TEST_SPEED]
# Home, get position, throw around toolhead, home again.
# If MCU stepper positions (first line in GET_POSITION) are greater than a full step different (your number of microsteps), then skipping occured.
# We only measure to a full step to accomodate for endstop variance.
# Example: TEST_SPEED SPEED=300 ACCEL=5000 ITERATIONS=10

description: Test for max speed and acceleration parameters for the printer. Procedure: Home -> ReadPositionFromMCU -> MovesToolhead@Vel&Accel -> Home -> ReadPositionfromMCU

gcode:
    # Speed
    {% set speed  = params.SPEED|default(printer.configfile.settings.printer.max_velocity)|int %}
    # Iterations
    {% set iterations = params.ITERATIONS|default(5)|int %}
    # Acceleration
    {% set accel  = params.ACCEL|default(printer.configfile.settings.printer.max_accel)|int %}
    # Minimum Cruise Ratio
    {% set min_cruise_ratio = params.MIN_CRUISE_RATIO|default(0.5)|float %}
    # Bounding inset for large pattern (helps prevent slamming the toolhead into the sides after small skips, and helps to account for machines with imperfectly set dimensions)
    {% set bound = params.BOUND|default(20)|int %}
    # Size for small pattern box
    {% set smallpatternsize = SMALLPATTERNSIZE|default(20)|int %}
    
    # Large pattern
        # Max positions, inset by BOUND
        {% set x_min = printer.toolhead.axis_minimum.x + bound %}
        {% set x_max = printer.toolhead.axis_maximum.x - bound %}
        {% set y_min = printer.toolhead.axis_minimum.y + bound %}
        {% set y_max = printer.toolhead.axis_maximum.y - bound %}
    
    # Small pattern at center
        # Find X/Y center point
        {% set x_center = (printer.toolhead.axis_minimum.x|float + printer.toolhead.axis_maximum.x|float ) / 2 %}
        {% set y_center = (printer.toolhead.axis_minimum.y|float + printer.toolhead.axis_maximum.y|float ) / 2 %}
        
        # Set small pattern box around center point
        {% set x_center_min = x_center - (smallpatternsize/2) %}
        {% set x_center_max = x_center + (smallpatternsize/2) %}
        {% set y_center_min = y_center - (smallpatternsize/2) %}
        {% set y_center_max = y_center + (smallpatternsize/2) %}

    # Save current gcode state (absolute/relative, etc)
    SAVE_GCODE_STATE NAME=TEST_SPEED
    
    # Output parameters to g-code terminal
    { action_respond_info("TEST_SPEED: starting %d iterations at speed %d, accel %d" % (iterations, speed, accel)) }
    
    # Home and get position for comparison later:
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28
        # QGL if not already QGLd (only if QGL section exists in config)
        {% if printer.configfile.settings.quad_gantry_level %}
            {% if printer.quad_gantry_level.applied == False %}
                QUAD_GANTRY_LEVEL
                G28 Z
            {% endif %}
        {% endif %} 
        # Move 50mm away from max position and home again (to help with hall effect endstop accuracy - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/24)
        G90
        G1 X{printer.toolhead.axis_maximum.x-50} Y{printer.toolhead.axis_maximum.y-50} F{30*60}
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28 X Y
        G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
        G4 P1000 
        GET_POSITION

    # Go to starting position
    G0 X{x_min} Y{y_min} Z{bound + 10} F{speed*60}

    # Set new limits
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} MINIMUM_CRUISE_RATIO={min_cruise_ratio}
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={speed} ACCEL={accel} ACCEL_TO_DECEL={accel / 2}
    {% endif %}

    {% for i in range(iterations) %}
        # Large pattern diagonals
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
        
        # Large pattern box
        G0 X{x_min} Y{y_min} F{speed*60}
        G0 X{x_min} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_max} F{speed*60}
        G0 X{x_max} Y{y_min} F{speed*60}
    
        # Small pattern diagonals
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
        
        # Small pattern box
        G0 X{x_center_min} Y{y_center_min} F{speed*60}
        G0 X{x_center_min} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_max} F{speed*60}
        G0 X{x_center_max} Y{y_center_min} F{speed*60}
    {% endfor %}

    # Restore max speed/accel/accel_to_decel to their configured values
    {% if printer.configfile.settings.printer.minimum_cruise_ratio is defined %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} MINIMUM_CRUISE_RATIO={printer.configfile.settings.printer.minimum_cruise_ratio} 
    {% else %}
        SET_VELOCITY_LIMIT VELOCITY={printer.configfile.settings.printer.max_velocity} ACCEL={printer.configfile.settings.printer.max_accel} ACCEL_TO_DECEL={printer.configfile.settings.printer.max_accel_to_decel}
    {% endif %}

    # Re-home and get position again for comparison:
        M400 # Finish moves - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/66
        G28 # This is a full G28 to fix an issue with CoreXZ - https://github.com/AndrewEllis93/Print-Tuning-Guide/issues/12
        # Go to XY home positions (in case your homing override leaves it elsewhere)
        G90
        G0 X{printer.toolhead.axis_maximum.x-1} Y{printer.toolhead.axis_maximum.y-1} F{30*60}
        G4 P1000 
        GET_POSITION

    # Restore previous gcode state (absolute/relative, etc)
    RESTORE_GCODE_STATE NAME=TEST_SPEED
    

##################################################
# REMEMBER TO TUNE SENSORLESS HOMING BEFORE ATTEMPTING TO PRINT!
# You'll find instructions in the generated sensorless-homing-*.cfg file(s),
# where you should keep your sensorless homing settings.
# REMEMBER TO CALIBRATE YOUR BEACON!
# Run BEACON_RATOS_CALIBRATE for automatic calibration.

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [beacon model default]
#*# model_coef = 1.6260111146370013,
#*# 	  1.9827876974551282,
#*# 	  0.7538114190102717,
#*# 	  0.21596268941204205,
#*# 	  0.16337965645484162,
#*# 	  0.3172491098136783,
#*# 	  -0.0183923466830494,
#*# 	  -0.23705571186825913,
#*# 	  0.07603835847026202,
#*# 	  0.12429123612404111
#*# model_domain = 1.888177263111525e-07,1.940168593704068e-07
#*# model_range = 0.199792,4.999792
#*# model_temp = 63.781822
#*# model_offset = 0.00000
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 62.088
#*# pid_ki = 2.059
#*# pid_kd = 467.991
#*#
#*# [bed_mesh ratos]
#*# version = 1
#*# points =
#*# 	  -0.915048, -0.901407, -0.909857
#*# 	  -0.946327, -0.929879, -0.926719
#*# 	  -0.911749, -0.894826, -0.887804
#*# x_count = 3
#*# y_count = 3
#*# mesh_x_pps = 2
#*# mesh_y_pps = 2
#*# algo = bicubic
#*# tension = 0.2
#*# min_x = 71.7507
#*# max_x = 257.139
#*# min_y = 80.7854
#*# max_y = 219.537
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 23.774
#*# pid_ki = 2.935
#*# pid_kd = 48.143
#*#
#*# [skew_correction my_skew_profile]
#*# xy_skew = -0.0005011288080393755
#*# xz_skew = 0.0
#*# yz_skew = 0.0
